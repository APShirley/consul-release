{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "S3 buckets for final consul blobs",

  "Resources": { 
    "ConsulBlobstoreUser": {
      "Type" : "AWS::IAM::User"
    },  
    "ConsulBlobstoreAccessKey": {
      "Type" : "AWS::IAM::AccessKey",
      "Properties": {
        "UserName": { "Ref": "ConsulBlobstoreUser" }
      }
    },
    "ConsulReleaseBlobsBucket": {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName" : "consul-release-blobs"
      }
    },
    "ConsulReleaseBlobsBucketPolicy": {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "PolicyDocument" : {
          "Id" : "consul-release-blobs-bucket-policy",
          "Statement" : [ { 
            "Sid" : "AllowReadForEveryone",
            "Action" : [
              "s3:GetObject"
            ],
            "Effect" : "Allow",
            "Principal" : "*",
            "Resource" : { "Fn::Join" : [
              "", [ "arn:aws:s3:::", { "Ref" : "ConsulReleaseBlobsBucket" } , "/*" ]
            ] }
          },
          { 
            "Sid" : "AllowList",
            "Action" : [
              "s3:ListBucket"
            ],
            "Effect" : "Allow",
            "Principal" : "*",
            "Resource" : { "Fn::Join" : [
              "", [ "arn:aws:s3:::", { "Ref" : "ConsulReleaseBlobsBucket" } ]
            ] }
          },
          { 
            "Sid" : "AllowWrite",
            "Action" : [
              "s3:PutObject"
            ],
            "Effect" : "Allow",
            "Principal" : {
              "AWS" : { "Fn::GetAtt" : [ "ConsulBlobstoreUser", "Arn" ] }
            },
            "Resource" : { "Fn::Join" : [
              "", [ "arn:aws:s3:::", { "Ref" : "ConsulReleaseBlobsBucket" } , "/*" ]
            ] }
          } ] 
        },
        "Bucket" : { "Ref" : "ConsulReleaseBlobsBucket" }
      }
    }
  },
  "Outputs" : {
    "ConsulBlobstoreAccessKeyID": {
      "Description": "Access Key ID",
      "Value": { "Ref": "ConsulBlobstoreAccessKey" }
    },
    "ConsulBlobstoreSecretAccessKey" : {
      "Description" : "Secret Key",
      "Value": { "Fn::GetAtt" : [ "ConsulBlobstoreAccessKey", "SecretAccessKey"]} 
    },
    "ConsulBlobstoreDomain" : {
      "Description": "Consul Blobstore Domain", 
      "Value": { "Ref": "ConsulReleaseBlobsBucket" }
    }
  }
}
